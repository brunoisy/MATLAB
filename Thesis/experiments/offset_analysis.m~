addpath('LSQ fit')
% filename = 'data/MAT/data_2/curve_1.mat';
filename = 'data/MAT_clean/data_4/curve_5.mat';
load(filename)

xlimits = [-10, 200];
ylimits = [-200, 50];

x0s = 0:5:30;

l = length(x0);
error = zeros(1,length(x0));


for j = 1:l
    %%% We find the FD curves going through the minimas, parametrized by Lc
    mins = find_min(dist, force, interval_length);
    Lc = merge_Lc(find_Lc(mins, x0),zeros(1,length(mins)), zeros(1,length(mins)));
    for j = 1:k
        %%% We select all the points that we will try to fit
        [Xfirst, Xunfold] = select_points(dist, force, x0, Lc, sel_thresh, sel_thresh);
        Xsel = [];
        Fsel = [];
        i = 1;
        while(i<=length(Lc))
            ninliers = sum(Xfirst(i)<=dist & dist<=Xunfold(i));
            if ninliers > min_inliers
                Xsel = [Xsel, dist(Xfirst(i)<=dist & dist<=Xunfold(i))];
                Fsel = [Fsel, force(Xfirst(i)<=dist & dist<=Xunfold(i))];
            else
                Lc(i:end-1) = Lc(i+1:end);
                Xunfold(i:end-1) = Xunfold(i+1:end);
                Xfirst(i:end-1) = Xfirst(i+1:end);
                Lc = Lc(1:end-1);
                Xunfold = Xunfold(1:end-1);
                Xfirst = Xfirst(1:end-1);
            end
            i=i+1;
        end

            Lc = lsqcurvefit(@(Lc,x) fd_multi([x0,Lc],x,Xunfold), Lc, Xsel,  Fsel);
        
        [Lc, Xfirst, Xunfold] = merge_Lc(Lc,Xfirst,Xunfold);
        
        Xsel = [];
        Fsel = [];
        for i = 1:length(Lc)
            Xsel = [Xsel, dist(Xfirst(i)<=dist & dist<=Xunfold(i))];
            Fsel = [Fsel, force(Xfirst(i)<=dist & dist<=Xunfold(i))];
        end
    end
    
end
error

