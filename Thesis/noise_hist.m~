global kb T lp C

kb = 1.38064852e-23;
T = 294;% 21Â°C
aa = 2*10^-9;% length of an amino acid
lp = 0.36*aa;%*0.7
C = kb*T/lp;

addpath('helpers')
comma2point_overwrite('curves_LmrP_proteoliposomes/good/curve_2.txt')% change commas to points

fileID = fopen('curves_LmrP_proteoliposomes/good/curve_2.txt');
Text = textscan(fileID, '%f %f');
fclose(fileID);
dist = Text{1}/10^15;% scaling factor
force = Text{2}/10^18;% 10^15 for curve 1?



%%% first step is to find local minimas of the FD profile. 
%%% We will assume those determine the position of a crest

maxmin = 9;%(max # of maxmin local minimas)
locmin = zeros(2,maxmin);
a = 1;
hi = 20; %size of half interval...
for i=1+hi:length(force)-hi
    locmin(:,a) = [dist(i); force(i)];
    a = a+1;
    if a>maxmin
        break
    end
    for j=[-hi:-1,1:hi]
        if(force(i+j)<force(i))
            a = a-1;
            break
        end
    end
end


% we compensate for offset
dist = dist-locmin(1,1);%better to subtract mean
locmin(1,:) = locmin(1,:)-locmin(1,1);

figure
hold on
plot(10^9*dist,10^12*force,'.')
plot(10^9*locmin(1,2:end),10^12*locmin(2,2:end),'*')
legend('data','minima')


Lc = zeros(1,maxmin);
for i = 2:maxmin % starting at 2 'cause first min is always bad
    Xi = locmin(1,i);
    Fi = locmin(2,i);

    A = 4*Fi/C;
    p = [A, 2*Xi*(3-A), -Xi^2*(9-A), 4*Xi^3];
    thisroots = roots(p);
    thisroots = thisroots(thisroots>0);
    Lc(i) = real(thisroots(1));
end



for i=1:maxmin
    X = linspace(0,Lc(i)*95/100,1000);
    F = fd_curve(Lc(i),X);
    plot(10^9*X,10^12*F);
    xlabel('Distance (nm)');
    ylabel('Force (pN)');
end





Lfit = Lc;

figure
hold on
for i=2:maxmin % for each valid minima
   % We select the points that are between this minima and the previous
   % one, and fit a FD curve with min least squares
   Xs = dist(dist(dist <= locmin(1,i))>locmin(1,i-1));
   Fs = force(dist(dist <= locmin(1,i))>locmin(1,i-1));
   
%    ft = fittype('fd_curve(a,x)');
%    F = fit(Xs,Fs,ft,'StartPoint',locmin(1,i));
   L = fminsearch(@(x) square_error(x, Xs, Fs),locmin(1,i));
   plot(10^9*Xs, 10^12*Fs,'.'); %initial datapoints
   plot(10^9*Xs, 10^12*fd_curve(L,Xs)); %least square fit
   xlabel('Distance (nm)');
    ylabel('Force (pN)');
end
